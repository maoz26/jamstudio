<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<title>Studio</title>
	<link rel="stylesheet" type="text/css" href="includes/style/stylesheetstudio.css">
	<link href="https://fonts.googleapis.com/css?family=Berkshire+Swash" rel="stylesheet">
	<link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
</head>
<body>
	<header>
		<ul>
			<li id="logo">
			J
			</li>
			<li id="connected_user">
				<div class="user_img" style="background-image: url(https://scontent.fhfa2-1.fna.fbcdn.net/v/t1.0-1/c26.7.40.40/p74x74/1374206_10151895529017929_1400551419_n.jpg?oh=d2a7b83d1a19fb557fb09fc50bc5b760&oe=5929F59B)"></div>
				<div class="username">israel.israeli@gmail.com <span>&#x25BC;</span></div>
			</li>
			<li id="toolbox">
				<ul>
					<li onclick="zoomIn()">(+)</li>
					<li onclick="zoomOut()">(-)</li>
					<li></li>
				</ul>
				<ul>
					<li></li>
					<li></li>
					<li></li>
				</ul>
			</li>
			<li id="searchbox">
			</li>
		</ul>
	</header>
	<main class="scrolls">
		<section id="channels_title">
			<article class="channel_list_buttons"></article>
			<article class="channels_grid_title"></article>
		</section>
		<section id="channels_list">
		</section>
	</main>
	<footer>
		
	</footer>
	<script>

		var max_time = 60*20;
		var time_units = 5;
		var unit_width = 10;
		var z_index = 3;

		function zoomIn(){
			if(unit_width==80)
				return;
			unit_width=unit_width*2;
			zoom();
			console.log("in");
		}
		function zoomOut(){
			if(unit_width==2.5)
				return;
			unit_width = unit_width/2;
			zoom();
			console.log("out");
		}

		function DrawGrid(unit_width){
				var cells = Math.round(max_time/time_units);
				// intialize elements
				$('#channels_list').html('');
				$('.channels_grid_title').html('');
				$('.channel_grid_row').html('');
				// generate grid title
				for (var i = 0; i < cells; i++) {
						$('.channels_grid_title').append('<div class="time-box">'+(i*time_units+time_units)+'</div><div class="time-box-border"></div>');
					}
				// generate grid rows
				for (var i = 0; i < 10; i++) {
					// create grid row
					var row = $('<div><article class="channel_list_row" ></article><article class="channel_grid_row" ondrop="drop(event)" ondragover="allowDrop(event)" id="channel_grid_row_'+i+'"></article></article></div>');
					// create and append, grid cells to grid row
					for (var j = 0; j < cells; j++) {
						$(row).find('.channel_grid_row').append('<div class="time-box"></div><div class="time-box-border"></div>');
					}
					// create and append, grid sample placeholder to grid row
					$(row).find('.channel_grid_row').append('<article class="sample_placeholder" id="sample_placeholder_'+ i +'"><article class="sample" id="sample'+ i +'" ondragstart="drag(event)" draggable="true" data-time="100" data-start="25"></article>');
					// append grid row to channel list
					$('#channels_list').append(row);
				}
				zoom();	
			}
		function zoom(){
			$('.channels_grid_title div.time-box').css('width',unit_width*time_units);
			$('.channel_grid_row').find('div.time-box').css('width',unit_width*time_units);
			var time_offset = secondsToOffset(max_time);
			$('.channels_grid_title').css('width',time_offset);
			$('.channel_grid_row').css('width',time_offset);
			$('#channels_list').css('width',time_offset+160);
			$('#channels_title').css('width',time_offset+160);
			$('.sample').each(function(){
				refreshSample(this);
			});
		}
		function refreshSample(element){
			$(element).css('width',$(element).attr("data-time")*unit_width+ ($(element).attr("data-time")/time_units-2));
			$(element).css('left',secondsToOffset($(element).attr("data-start")));
		}
		function refreshSamples(){
			$('.sample').each(function(data){
				refreshSample(this);
			});	
		}
		function offsetToSeconds(offset){
			var borders = Math.floor(offset/((time_units*unit_width)));
		    var all = ((offset-borders)/(time_units*unit_width))*time_units;
		    return all;
		}
		function secondsToOffset(sec){
			var real = Math.floor(sec*unit_width);
			var borders = Math.floor(real/((time_units*unit_width)));
		    return real+borders;
		}

		function collouringGridRow(el,isMulti){
			console.log(isMulti);
			if(isMulti)
				if($(el.target).parent().hasClass('row_pressed'))
					$(el.target).parent().removeClass('row_pressed');
				else
					$(el.target).parent().addClass('row_pressed');
			else{
				$('.channel_grid_row').removeClass('row_pressed');
				$(el.target).parent().addClass('row_pressed');
			}
		}

		// drag and drop 
		function allowDrop(ev) {
		    ev.preventDefault();
		}
		function drag(ev) {
		    ev.dataTransfer.setData("text", ev.target.id);
		    console.log(ev.target.style.left);	
		}
		function drop(ev) {
		    ev.preventDefault();
		    var data = ev.dataTransfer.getData("text");
		    var dragged = document.getElementById(data);		   
		    var target = ev.target;
		    var new_offset = $('main').scrollLeft()+ ev.pageX - mouse_offset - 160;
	    	if(new_offset<0)
	    		new_offset = 0;
	    	// drop on sample
		    if($(target).hasClass('sample')){
		    	if($(target).parent().attr('id') != $(dragged).parent().attr('id')){
		    		$($(target).parent()).append(dragged); // drop on sample on other layer
		    	}
				$('#'+data).css('left', new_offset);
		    }
		    // drop on layer
		    else{
		    	($(target).parent()).find('.sample_placeholder').append(dragged);
		    	$('#'+data).css('left', new_offset);
		    }
		    // z-index up
		    $('#'+data).css('z-index', z_index++);
		    // define new start
		    var borders = Math.floor(new_offset/((time_units*unit_width)));
		    var all = ((new_offset-borders)/(time_units*unit_width))*time_units;
		    $('#'+data).attr('data-start', all);
		    console.log('start at: '+ all);
		}

		// Listeners
		var mouse_offset;
		$(document).on('mousedown', function(e){
		    mouse_offset = e.pageX - $(e.target).offset().left;
		});
		$(document).on('mouseup', function(e){
	
		});
		$(document).bind('click',function(el){	
			if($(el.target).hasClass('sample'))
		    	$(el.target).css('z-index', z_index++);
		});
		var shifted = false;
		$(document).on('keyup keydown', function(e){shifted = e.shiftKey} );

		$(document).ready(function(){
			DrawGrid(unit_width);
		});
		


	</script>
</body>
</html>